# PRD：个人 A 股 ETF 回测与分析工具（MVP）

## 1. 文档信息

- 版本：v1.0
- 状态：可实施
- 目标周期：2-3 周
- 核心验收标准：同参数同数据结果可复现

## 2. 背景与目标

### 2.1 背景

当前需求是开发一个个人使用的回测工具，并具备可用于面试展示的完整度。  
现阶段最大的失败风险不是功能数量，而是结果口径不统一导致“看起来能跑、但不可复核”。

### 2.2 产品目标

1. 支持 A 股 ETF 的定投回测，用户可选择标的、时间与参数后执行。
2. 输出可解释的回测结果（收益、回撤、夏普等）与图表。
3. 支持随机实验（随机起点 + 随机持有期）并展示统计分布。
4. 支持 AI 生成自然语言长报告，作为复盘与展示材料。
5. 保证重复运行可复现，作为 MVP 质量底线。

### 2.3 非目标（MVP 不做）

1. 不支持个股回测。
2. 不支持用户自定义策略 DSL/拖拽编排。
3. AI 不参与策略搜索、自动调参、联网检索。
4. 不做多用户系统、权限体系、云端部署。

## 3. 用户与场景

### 3.1 用户画像

1. 主要用户：项目作者本人（高频试验与复盘）。
2. 次要用户：面试官（关注工程完整性、结果可信度与表达清晰度）。

### 3.2 关键场景

1. 输入参数后快速拿到一次完整回测结果。
2. 通过随机实验观察策略在不同持有区间下的收益与回撤分布。
3. 一键生成可阅读的分析报告，用于总结或展示。

## 4. 交付形态与技术栈

### 4.1 交付形态

- 本地 Web 应用（浏览器访问，本机运行服务）。

### 4.2 技术栈

1. 后端：Python + FastAPI。
2. 数据：AkShare/TuShare（适配层封装）。
3. 存储：SQLite（运行记录、参数快照、任务元数据）。
4. 前端：React + TypeScript（参数页、结果页、实验页）。

## 5. 功能范围（MVP）

### 5.1 参数配置页

1. ETF 选择：代码/名称检索。
2. 时间范围：开始日期、结束日期。
3. 定投参数：单次投入金额、投放频率（周/月）、执行日规则。
4. 成本参数：真实成本规则默认开启，支持参数查看与覆盖。
5. 执行动作：发起单次回测任务。

### 5.2 回测结果页

1. 指标卡：累计收益率、年化收益率、最大回撤、年化波动率、夏普比率。
2. 图表：净值曲线、回撤曲线、投入金额 vs 资产市值曲线。
3. 明细：按交易日展示持仓、投入、费用、资产总值。
4. 导出：JSON/CSV（包含 input snapshot 与计算版本）。

### 5.3 随机实验页

1. 参数：实验次数 N、最短持有天数、最长持有天数、随机种子。
2. 采样：随机起点 + 随机持有期。
3. 输出：收益分布、最大回撤分布、P10/P50/P90 等分位数。
4. 对照：单次回测结果在分布中的位置。

### 5.4 AI 报告

1. 输入仅来自内部结果：回测指标、策略参数、随机实验统计摘要。
2. 输出为自然语言长报告。
3. 报告结构至少包含：结论摘要、收益解释、风险提示、适用/不适用条件、后续试验建议。
4. 同一输入下保持结构稳定，避免报告完全不可比较。

## 6. 回测规则与计算口径

### 6.1 数据口径

1. 使用日频数据。
2. 资产限定为 A 股 ETF。
3. 采用统一复权规则（默认前复权），并在结果元数据中记录。
4. 缺失交易日处理：不成交，持仓延续，记录事件日志。

### 6.2 交易执行口径

1. 定投频率支持周/月。
2. 成交价默认使用当日收盘价近似。
3. 默认不做滑点（预留参数位，MVP 默认 0）。

### 6.3 成本模型（真实规则细分）

1. 拆分为佣金、印花税（如适用）、过户费（如适用）。
2. 支持最小费用门槛逻辑。
3. 费用模型版本化，写入结果快照用于追溯。

### 6.4 指标定义

1. 最大回撤：净值相对历史峰值的最大跌幅。
2. 夏普比率：基于年化收益、年化波动率与固定无风险利率计算。
3. 所有公式统一收敛到指标定义文档（实现阶段生成 `docs/metric_definitions.md`）。

## 7. 系统架构与模块

### 7.1 模块划分

1. `data_provider`：数据拉取、清洗、字段标准化。
2. `backtest_engine`：定投执行、成本计算、指标计算。
3. `experiment_runner`：随机实验批量执行与统计聚合。
4. `report_service`：AI 报告提示词模板与生成逻辑。
5. `api_service`：FastAPI 接口层与任务编排。
6. `frontend`：三页面交互与可视化展示。

### 7.2 数据流（简述）

1. 前端提交参数到 API。
2. API 调用数据层获得标准行情。
3. 回测引擎输出单次结果。
4. 实验模块基于同策略批量采样输出统计。
5. 报告服务读取结果并生成长报告。
6. 全链路持久化参数快照和运行版本信息。

## 8. API 契约（公共接口）

### 8.1 接口列表

1. `GET /api/etfs`
   - 用途：获取 ETF 列表（支持关键字）。
2. `POST /api/backtests/run`
   - 用途：执行单次回测。
3. `POST /api/experiments/run`
   - 用途：执行随机实验。
4. `POST /api/reports/generate`
   - 用途：生成 AI 长报告。
5. `GET /api/runs/{run_id}`
   - 用途：查询历史运行明细与导出信息。

### 8.2 请求体关键字段（示意）

1. `backtests/run`
   - `symbol`
   - `start_date`
   - `end_date`
   - `invest_amount`
   - `frequency`（weekly/monthly）
   - `cost_model`
2. `experiments/run`
   - `base_strategy_params`
   - `trials`
   - `min_holding_days`
   - `max_holding_days`
   - `random_seed`
3. `reports/generate`
   - `backtest_result`
   - `experiment_summary`
   - `report_style`

### 8.3 响应约束

1. 所有核心响应必须带 `input_snapshot`。
2. 返回 `engine_version` 与 `metric_definition_version`。
3. 错误结构统一：`code`、`message`、`details`、`request_id`。

## 9. 非功能需求

1. 可复现性：固定 `random_seed` 时实验结果一致。
2. 性能目标：
   - 单次 5 年回测：目标 <= 3s（普通本地环境）。
   - 100 次随机实验：目标 <= 30s。
3. 稳定性：外部数据异常可定位、可重试。
4. 可观测性：关键流程日志 + 异常日志 + 运行耗时。
5. 可演示性：可导出结构化结果与报告文本。
6. 可维护性（注释强约束）：
   - 每个非极简文件必须有文件头用途说明。
   - 每个非极简函数必须有注释，包含作用、入参、出参。
   - 核心类型/模型字段需补充语义说明，极简字段可省略。

## 10. 测试与验收

### 10.1 单元测试

1. 成本计算（含最小费用边界）。
2. 定投日期触发规则（周/月）。
3. 指标函数（收益、回撤、波动、夏普）。
4. 随机实验采样边界（最短/最长持有期）。

### 10.2 集成测试

1. 数据拉取 -> 回测计算 -> 指标输出全链路。
2. 随机实验批量执行与统计聚合链路。
3. 报告生成链路（可先 mock 大模型服务）。

### 10.3 验收场景

1. 同参数同数据运行 3 次结果完全一致。
2. 固定 seed 的随机实验结果一致。
3. 成本开/关导致收益差异方向符合预期。
4. 数据源失败时，前端展示可执行的报错信息。

## 11. 项目计划（2-3 周）

1. 第 1 周：数据适配 + 回测引擎 + 指标计算 + API 基线。
2. 第 2 周：参数页/结果页/实验页三页闭环 + 图表。
3. 第 3 周：AI 报告 + 测试补齐 + 演示材料整理。

## 12. 风险与应对

1. 数据源字段变化导致解析失败。
   - 应对：适配层隔离 + 字段校验 + 降级日志。
2. 真实成本模型复杂度高。
   - 应对：MVP 覆盖主流规则，少见规则采用配置扩展。
3. 仅定投策略展示亮点不足。
   - 应对：强化随机实验分析与 AI 解释质量。
4. 长报告比较困难。
   - 应对：固定报告章节结构，保证跨实验可读性。

## 13. 默认假设与决策锁定

1. 首版资产范围：仅 A 股 ETF。
2. 首版策略范围：仅定投。
3. 计算频率：日频数据 + 周/月执行。
4. 成本模型：真实规则细分。
5. 随机实验：随机起点 + 随机持有期。
6. AI 输入：仅内部回测结果，不联网。
7. AI 输出：自然语言长报告。
8. 交付形态：本地 Web 应用。
9. 前端主栈：React + TypeScript。
