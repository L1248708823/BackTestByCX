# 编码助手协作约定（cx回测）

## 交流

- 默认用中文沟通，结论清晰可执行。
- 需求不确定时先列出不确定点并询问，不“先改再说”。
- 关键信息缺失必须暂停并询问，不在缺证据条件下自拟实现。
- 每次回答开头使用“曼波~”。

## 项目定位

- 这是学习 + 个人项目。
- 优先级：可读性与可解释性 > 炫技与过度优化。
- 任何抽象设计都要给出“当前收益”，没有收益就保持简单。

## 协作边界（代码 vs 安装）

- 代码改动由助手负责：源码、配置、文档。
- 依赖安装由你负责：`pnpm install / pnpm add / pnpm remove` 等。
- 新增依赖必须先说明原因、最小方案与备选方案，再等待确认。
- 验证方式：助手给命令和预期现象，你执行后回传关键日志。

## 环境提醒（常见坑）

- 项目位于 WSL 的 `/mnt/<盘符>/...`，`pnpm` 可能出现权限或重命名问题，涉及安装时优先提醒用户执行。

## 技术栈与架构约束（必须执行）

- 前端默认技术栈：React + TypeScript（函数组件 + Hooks）。
- 后端默认技术栈：Python + FastAPI。
- 前后端分离开发，默认同仓库组织（`frontend/` + `backend/`）。
- 无明确需求时不引入重型框架或复杂中间件。

## 注释与可读性规范（前后端都必须执行）

- 每个非极简源码文件开头必须有“文件用途说明”注释（做什么、被谁使用）。
- 每个非极简函数必须补注释：
  - 作用
  - 入参
  - 出参
  - 必要时补充副作用与边界条件
- 类型/数据结构字段必须声明语义；仅明显通用字段可省略（例如 `id`、`name`）。
- API 请求体、响应体、持久化模型字段必须注明业务含义。
- 复杂或反直觉逻辑必须补“为什么这么做”的注释。
- “极简”判定：不超过 3 行、无分支、无副作用、命名可直观表达语义。

## React 代码组织约束（必须执行）

- 只使用函数组件与 Hooks，不使用 class 组件。
- 复用逻辑达到 2 处及以上时，优先抽离自定义 Hook。
- 页面逻辑按模块分段（初始化、数据查询、交互操作、副作用、渲染）。
- 组件文件过大时优先拆分为同目录子组件，避免单文件膨胀。

## Python 后端约束（必须执行）

- 路由层不写核心业务逻辑，业务逻辑放到 service/usecase 层。
- 对外数据结构使用明确的 schema（如 Pydantic 模型）并补字段说明。
- 公共函数与核心类使用 docstring，保持输入输出与异常语义可追踪。

## 大文件拆分判定与执行

- 触发“先询问是否拆分”的条件：单文件超过 450 行，或 TS/TSX 逻辑超过 220 行，或 JSX 结构超过 260 行。
- 可明确识别为低耦合可复用模块时，可直接抽离到 `frontend/src/components/` 或 `frontend/src/hooks/`。
- 页面专属模块优先就近放在页面目录下，避免过早全局化。
- 涉及跨模块状态、权限或路由耦合的拆分，先询问后执行。

## 样式约束（必须执行）

- 优先使用语义化设计 Token，避免无语义硬编码颜色。
- 禁止新增全局样式污染（避免直接对 `a`、`button`、`div` 等标签施加业务样式）。

## 本地文档与 TODO 维护（必须执行）

> 约定：`localDoc/` 为本机本地资料目录，不提交到版本库。

- 每完成一个可独立验收的功能模块后，必须同步更新 `localDoc/TODO.md`。
- 依赖、安装流程、启动流程变更时，必须同步更新：
  - `docs/dependency-checklist.md`
  - `docs/install-guide-windows.md`
  - `docs/startup-runbook.md`
- 所有需要你人工执行的命令，必须先记录到：
  - `docs/manual-operations-playbook.md`
  并写明命令作用、预期结果、失败排查提示。
- TODO 更新至少包含：
  - 完成项勾选
  - 你需要执行的命令/验证点
  - 变更记录（日期 + 模块 + 关键文件）
